<!DOCTYPE html>
<html lang="en">
	<head>
		<title>Flocking Simulation</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<style>
			body {
				margin: 0px;
				overflow: hidden;
				cursor: pointer;
			}
		</style>
	</head>
	<body>
		<div id="info">
		 <span id="birds"></span>
		 </div>

		<script src="js-libs/three.js"></script>
		<script src="js-libs/Detector.js"></script>
		<script src="js-libs/stats.min.js"></script>
		<script src="js-libs/dat.gui.min.js"></script>
		<script src="js-libs/GPUComputationRenderer.js"></script>
		<script src="js-libs/FirstPersonControls.js"></script>
		<script src="js-libs/OrbitControls.js"></script>
		<script src="js-libs/KeyboardState.js"></script>

		<!-- fragment shader for bird's position -->
		<script id="BoidPositionFragmentShader" type="x-shader/x-fragment">
			uniform float clock;
			uniform float del_change;
			void main()	{
				vec2 textcoordi = gl_FragCoord.xy / resolution.xy;
				vec4 temp_position = texture2D( PositionTexture, textcoordi );
				vec3 position = temp_position.xyz;
				vec3 velocity = texture2D( VeloctiyTexture, textcoordi ).xyz;

				float wcoordinate = temp_position.w;

				wcoordinate = mod( ( wcoordinate + del_change*2.0 +
					length(velocity.xz) * del_change * 3. +
					max(velocity.y, 0.0) * del_change * 6. ), 50.0 );

				gl_FragColor = vec4( position + velocity * del_change * 15. , wcoordinate );}
		</script>

		<!-- fragment shader for bird's geometry -->
		<script id="BoidGeometryFragmentShader">
			varying vec4 vertex_color;
			varying float zcoordi;

			void main() {
				float z = 0.2 + ( 1000. - zcoordi ) / 1000. * vertex_color.x;
				gl_FragColor = vec4( z, z, z, 1. );}
		</script>

		<!-- vertex shader for bird's position -->
		<script id="BoidVertexShader">
			uniform float clock;

			attribute vec2 reference;
			attribute float birdVertex;
			attribute vec3 birdColor;

			uniform sampler2D PositionTexture;
			uniform sampler2D VeloctiyTexture;

			varying vec4 vertex_color;
			varying float zcoordi;

			void main() {
				vec4 temp_position = texture2D( PositionTexture, reference );
				vec3 pos = temp_position.xyz;
				vec3 velocity = normalize(texture2D( VeloctiyTexture, reference ).xyz);
				vec3 newPosition = position;

				if ( birdVertex == 4.0 || birdVertex == 7.0 ){ newPosition.y = sin( temp_position.w ) * 5.;}

				newPosition = mat3( modelMatrix ) * newPosition;

				velocity.z *= -1.;
				float xz = length( velocity.xz );
				float xyz = 1.;
				float x = sqrt( 1. - velocity.y * velocity.y );

				float cosry = velocity.x / xz;
				float sinry = velocity.z / xz;

				float cosrz = x / xyz;
				float sinrz = velocity.y / xyz;

				mat3 maty =  mat3( cosry, 0, -sinry, 0 , 1, 0 ,sinry, 0, cosry);
				mat3 matz =  mat3( cosrz , sinrz, 0, -sinrz, cosrz, 0, 0, 0, 1);

				newPosition =  maty * matz * newPosition;
				newPosition += pos;

				zcoordi = newPosition.z;

				vertex_color = vec4( birdColor, 1.0 );
				gl_Position = projectionMatrix *  viewMatrix  * vec4( newPosition, 1.0 );
			}
		</script>

		<!-- Main script -->

		<script>
			if ( ! Detector.webgl ) Detector.addGetWebGLMessage();

			var hash = document.location.hash.substr( 1 );
			if (hash) hash = parseInt(hash, 0);

			var argumentHash = hash || 32;
			var birds = argumentHash * argumentHash;

			THREE.BirdGeometry = function () {
				var triangles = birds * 3;
				var points = triangles * 3;

				THREE.BufferGeometry.call( this );

				var vertices = new THREE.BufferAttribute( new Float32Array( points * 3 ), 3 );
				var birdColors = new THREE.BufferAttribute( new Float32Array( points * 3 ), 3 );
				var references = new THREE.BufferAttribute( new Float32Array( points * 2 ), 2 );
				var birdVertex = new THREE.BufferAttribute( new Float32Array( points ), 1 );

				this.addAttribute( 'position', vertices );
				this.addAttribute( 'birdColor', birdColors );
				this.addAttribute( 'reference', references );
				this.addAttribute( 'birdVertex', birdVertex );

				var v = 0;
				function vertex_append() {
					for (var i=0; i < arguments.length; i++) {
						vertices.array[v++] = arguments[i];
					}
				}
				for (var f = 0; f<birds; f++ ) {
					vertex_append(
						0, -0, -6,
						0, 1, -15,
						0, 0, 8);
					vertex_append(
						0, 0, -4,
						-6, 0, 0,
						0, 0, 4);
					vertex_append(
						0, 0, 4,
						6, 0, 0,
						0, 0, -4);
				}

				for( var v = 0; v < triangles * 3; v++ ) {
					var i = ~~(v / 3);
					var x = (i % argumentHash) / argumentHash;
					var y = ~~(i / argumentHash) / argumentHash;

					var c = new THREE.Color(0x000000);

					birdColors.array[v*3+0] = c.r;
					birdColors.array[v*3+1] = c.g;
					birdColors.array[v*3+2] = c.b;
					references.array[v*2] = x;
					references.array[v*2+1] = y;
					birdVertex.array[v] = v % 9;
				}
				this.scale( 0.35, 0.35, 0.35 );
			};
			</script>
	</body>
</html>